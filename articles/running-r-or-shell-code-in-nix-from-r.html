<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="rix">
<title>Running R or shell code in Nix from R • rix</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Running R or shell code in Nix from R">
<meta property="og:description" content="rix">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">rix</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.5.1.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/building-an-environment-for-literate-programming.html">Building an environment for literate programming</a>
    <a class="dropdown-item" href="../articles/building-reproducible-development-environments-with-rix.html">Building reproducible development environments with rix</a>
    <a class="dropdown-item" href="../articles/handling-packages-with-remote-dependencies.html">Handling packages with remote dependencies</a>
    <a class="dropdown-item" href="../articles/interactive-use.html">Interactive use</a>
    <a class="dropdown-item" href="../articles/reproducible-analytical-pipelines-with-nix.html">Reproducible Analytical Pipelines with Nix</a>
    <a class="dropdown-item" href="../articles/running-r-or-shell-code-in-nix-from-r.html">Running R or shell code in Nix from R</a>
    <a class="dropdown-item" href="../articles/save-the-nix-package-versions-data.html">Save the Nix Package Versions data</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Running R or shell code in Nix from R</h1>
            
      
      
      <div class="d-none name"><code>running-r-or-shell-code-in-nix-from-r.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">rix</span><span class="op">)</span></span></code></pre></div>
<!-- WARNING - This vignette is generated by {fusen} from dev/running_r_or_shell_code_in_nix_from_r.Rmd: do not edit by hand -->
<div class="section level2">
<h2 id="testing-code-in-evolving-software-dependency-environments-with-confidence">
<strong>Testing Code in Evolving Software Dependency Environments
with Confidence</strong><a class="anchor" aria-label="anchor" href="#testing-code-in-evolving-software-dependency-environments-with-confidence"></a>
</h2>
<p>Adhering to sound versioning practices is crucial for ensuring the
reproducibility of software. Despite the expertise in software
engineering, the ever-growing complexity and continuous development of
new, potentially disruptive features present significant challenges in
maintaining code functionality over time. This pertains not only to
backward compatibility but also to future-proofing. When code handles
critical production loads and relies on numerous external software
libraries, it’s likely that these dependencies will evolve.
Infrastructure-as-code and other DevOps principles shine in addressing
these challenges. However, they may appear less approachable and more
labor-intensive to set up for the average R developer.</p>
<p>Are you ready to test your custom R functions and system commands in
a a different environment with isolated software builds that are both
pure at build and at runtime, without leaving the R console?</p>
<p>Let’s introduce <code><a href="../reference/with_nix.html">with_nix()</a></code>. <code><a href="../reference/with_nix.html">with_nix()</a></code> will
evaluate custom R code or shell commands with command line interfaces
provided by Nixpkgs in a Nix environment, and thereby bring the
read-eval-print-loop feeling. Not only can you evaluate custom R
functions or shell commands in Nix environments, but you can also bring
the results back to your current R session as R objects.</p>
</div>
<div class="section level2">
<h2 id="two-operational-modes-of-computations-in-environments-system-to-nix-and-nix-to-nix">
<strong>Two Operational Modes of Computations in Environments:
‘System-to-Nix’ and ‘Nix-to-Nix’</strong><a class="anchor" aria-label="anchor" href="#two-operational-modes-of-computations-in-environments-system-to-nix-and-nix-to-nix"></a>
</h2>
<p>We aim to accommodate various use cases, considering a gradient of
declarativity in individual or sets of software environments based on
personal preferences. There are two main modes for defining and
comparing code running through R and system commands (command line
interfaces; CLIs)</p>
<ol style="list-style-type: decimal">
<li>
<strong>‘System-to-Nix’</strong> environments: We assume that you
launch an R session with an R version defined on your host operating
system, either from the terminal or an integrated development
environment like RStudio. You need to make sure that you actively
control and know where you installed R and R packages from, and at what
versions. You may have interactively tested that your custom function
pipeline worked for the current setup. Most importantly, you want to
check whether you get your computations running and achieve identical
results when going back to a Nix revision that represent either newer or
also older versions of R and package sources.</li>
<li>
<strong>‘Nix-to-Nix’</strong> environments: Your goals of testing
code are the same as in 1., but you want more fine-grained control in
the source environment where you launch `with_nix()` from, too. You are
probably on the way of getting a passionate Nix user.</li>
</ol>
</div>
<div class="section level2">
<h2 id="case-study-1-evolution-of-base-r">
<strong>Case study 1: Evolution of base R</strong><a class="anchor" aria-label="anchor" href="#case-study-1-evolution-of-base-r"></a>
</h2>
<p>Carefully curated software improves over time, so does R. We pick an
example from the R changelog, the following <a href="https://cran.r-project.org/doc/manuals/r-release/NEWS.html" class="external-link">literal
entry in R 4.2.0</a>:</p>
<ul>
<li>“<code><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector()</a></code> gains a <code>data.frame</code> method
which returns a simple named list, also clearing a long standing ‘FIXME’
to enable <code>as.vector(&lt;data.frame&gt;, mode="list")</code>. This
breaks code relying on <code>as.vector(&lt;data.frame&gt;)</code> to
return the unchanged data frame.”</li>
</ul>
<p>The goal is to illustrate this change in behavior before and after R
version 4.2.0.</p>
<div class="section level3">
<h3 id="setting-up-the-software-environment-with-nix">Setting up the software environment with Nix<a class="anchor" aria-label="anchor" href="#setting-up-the-software-environment-with-nix"></a>
</h3>
<p>We first create a isolated directory to prepare for a Nix
environment, and write a custom <code>.Rprofile</code> file as well.
Startup code written to this local <code>.Rprofile</code> will make sure
that the system’s user library (R_LIBS_USER) is excluded from library
paths to load packages from. The R derivation in Nixpkgs includes the
user library at first position (returned by <code><a href="https://rdrr.io/r/base/libPaths.html" class="external-link">.libPaths()</a></code>).
This is nice to install packages from a Nix-R session environment in
ad-hoc and interactive manner. However, this comes at the cost that one
needs be aware of potential run-time pollution of packages outside the
pool of paths per package from the nix store. On macOS, we experienced a
high-chance of segmentation faults when accidentally loading packages
and linked system libraries from the system’s user library, to give an
example. rix::init() writes a configuration that takes care of
runtime-pure R package libraries from declaratively defined Nix builds.
Additionally, it modifies <code><a href="https://rdrr.io/r/base/libPaths.html" class="external-link">.libPaths()</a></code> in the running R
session.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st">"rix"</span><span class="op">)</span></span>
<span><span class="va">path_env_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"."</span>, <span class="st">"_env_1_R4-2-0"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/init.html">init</a></span><span class="op">(</span></span>
<span>  project_path <span class="op">=</span> <span class="va">path_env_1</span>,</span>
<span>  rprofile_action <span class="op">=</span> <span class="st">"overwrite"</span>,</span>
<span>  message_type <span class="op">=</span> <span class="st">"simple"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Next, we write a <code>default.nix</code> file containing Nix
expressions that pin R version 4.2.0 from Nixpkgs.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rix.html">rix</a></span><span class="op">(</span></span>
<span>  r_ver <span class="op">=</span> <span class="st">"4.2.0"</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  project_path <span class="op">=</span> <span class="va">path_env_1</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="defining-and-interactively-testing-custom-r-code-with-functions">Defining and interactively testing custom R code with
function(s)<a class="anchor" aria-label="anchor" href="#defining-and-interactively-testing-custom-r-code-with-functions"></a>
</h3>
<p>We know have set up the configuration for R 4.2.0 set up in a
<code>default.nix</code> file in the folder
<code>./_env_1_R-4-2-0</code>. Since you are sure you are using an R
version higher 4.2.0 available on your system, you can check what that
<code><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector.data.frame()</a></code> S3 method returns a list.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, b <span class="op">=</span> <span class="fl">4</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">df</span>, mode <span class="op">=</span><span class="st">"list"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="run-functioned-up-code-and-investigate-results-produced-in-pure-nix-r-software-environments">Run functioned up code and investigate results produced in pure Nix
R software environments<a class="anchor" aria-label="anchor" href="#run-functioned-up-code-and-investigate-results-produced-in-pure-nix-r-software-environments"></a>
</h3>
<p>To formally validate in a ‘System-to-Nix’ approach that the
<code>out</code> object is identical since <code>R</code> &gt;= 4.2.0,
we define a function that runs the computation above.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_as_vector</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, mode <span class="op">=</span> <span class="st">"list"</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="op">(</span><span class="va">out_system</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">df</span>, mode <span class="op">=</span><span class="st">"list"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Then, we will evaluate this test code through a
<code>nix-shell</code> R session. This adds both build-time and run-time
purity with the declarative Nix software configuration we have made
above. with_nix leverages the following principles under the hood:</p>
<ul>
<li><p><strong>Computing on the language</strong>: manipulate language
objects using code</p></li>
<li><p><strong>Static code analysis</strong>: detect global objects and
package environments in the function call stack of <code>expr</code>.
For that, important {codetools} functionality is used, which is
recursively iterated.</p></li>
<li><p><strong>Serializing</strong> dependent <strong>R objects</strong>
(save them to disk) and <strong>deserializing</strong> (read them back
into RAM of R session) via a temporary folder. This creates isolation of
two distinct computational environments, for both ‘System-to-Nix’ and
‘Nix-to-Nix’ computational modes. At the same time this allows to
shuffle and input arguments of <code>expr</code> , dependencies across
the call stack and as well its outputs back-and-forth between the Nix-R
and the system’s R sessions.</p></li>
</ul>
<p>This approach guarantees reproducible side effects, and effectively
streams messages and errors into the R session. Thereby, the {sys}
package facilitates capturing standard outputs and errors as text output
messages.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_as_vector</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, mode <span class="op">=</span> <span class="st">"list"</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># now run it in `nix-shell`; `with_nix()` takes care</span></span>
<span><span class="co"># of exporting global objects of `df_as_vector` recursively</span></span>
<span><span class="va">out_nix</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/with_nix.html">with_nix</a></span><span class="op">(</span></span>
<span>  expr <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu">df_as_vector</span><span class="op">(</span>x <span class="op">=</span> <span class="va">df</span><span class="op">)</span>, <span class="co"># wrap to avoid evaluation</span></span>
<span>  program <span class="op">=</span> <span class="st">"R"</span>, </span>
<span>  exec_mode <span class="op">=</span> <span class="st">"non-blocking"</span>, <span class="co"># run as background process</span></span>
<span>  project_path <span class="op">=</span> <span class="va">path_env_1</span>, </span>
<span>  message_type <span class="op">=</span> <span class="st">"simple"</span> <span class="co"># you can do `"verbose"`, too</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># compare results of custom codebase with indentical </span></span>
<span><span class="co"># inputs and different software environments</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">out_system</span>, <span class="va">out_nix</span><span class="op">)</span></span>
<span><span class="co"># should return `TRUE` if your system's R versions in</span></span>
<span><span class="co"># current interactive R session is R &gt;= 4.2.0</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="case-study-2-breaking-changes-in-stringr-1-5-0">
<strong>Case study 2: Breaking changes in {stringr}
1.5.0</strong><a class="anchor" aria-label="anchor" href="#case-study-2-breaking-changes-in-stringr-1-5-0"></a>
</h2>
<p>We add one more layer to the reproducibility of the R ecosystem. User
libraries from CRAN or GitHub, one thing that makes R shine is the huge
collection of software packages available from the community.
Despite</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Bruno Rodrigues, Philipp Baumann.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
